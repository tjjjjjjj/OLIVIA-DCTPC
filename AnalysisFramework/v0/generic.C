
#include "../../MaxCam/MaxCamMC.hh"
#include "../../MaxCam/MaxCamImageTools.hh"
#include "../../MaxCam/MaxCamCluster.hh"
#include "../../MaxCam/DmtpcEvent.hh"
#include "../../MaxCam/DmtpcDataset.hh"
#include "TF1.h"
#include "TSystem.h"
#include "TVector3.h"
#include "TRandom.h"
#include "TProfile.h"
#include "TTree.h"
#include "TFile.h"
#include "TRandom.h"
#include "TMath.h"
#include "TRandom3.h"
#include "TCanvas.h"

#include <fstream>
#include <iostream>
#include <vector>

using namespace std;

//This is a generic analysis module
//DO NOT EDIT THIS FILE
//Copy this file to another file, then edit for your purposes


int generic(TString rawdatafiles="files.txt", TString keyfilename="keys.txt",TString dir = "./generic/")
{
   //the key for this module
   TString key = "generic";

   //required keys go here
   const int nreqmod = 0;
   TString reqmod[nreqmod];
   
   bool pass;
   DmtpcKeys k(keyfilename,rawdatafiles,key,dir,nreqmod,reqmod,pass);
   if(!pass) return -1;

   //pointers to file and tree outside loop
   TFile* routfile;
   TTree* newtree;
   for(int f=0; f<k.getNFiles(); f++)
   {
      //Create DMPTC Database and draw out tree
      DmtpcDataset d;
      d.openRootFile(rootdirname+rootfilename);
      TTree* rawtree = d.tree();

      //Add friends
      k.addFriends(rawtree,f);
      
      //name outputfile, open up outputfile
      TString routfilename = rootfilename;
      routfilename.ReplaceAll(".root",key+".root");

      routfile = new TFile(dir+routfilename,"CREATE");
      if(routfile->IsOpen())
      {
	 routfile->cd();
      }
      else
      {
	 cout << "Output file already exists; Aborting!" << endl;
	 return -1;
      }
      // check how many cameras we've got.
      d.getEvent(0);
      const int ncamera = d.event()->ccdData()->GetEntries();
      
      //create tree to store variables
      newtree = new TTree(key,"Title");
   
      //Add branches
      
      //don't delete this line (memory management)
      gROOT->cd();

      //loop over events
      for(int i = 0; i<rawtree->GetEntries(); i++)
//     for(int i = 0; i<50; i++) //for testing
      {
	 cout << i << endl;
	 d.getEvent(i);
	 rawtree->GetEvent(i);
	 for(int u =0; u<ncamera; u++)
	 {
	    
	    
	 }
	 routfile->cd();
	 newtree->Fill();
	 gROOT->cd();
      }
   
      //clean up. Don't edit!
      routilfe->cd();
      newtree->Write();
      gROOT->cd();
      
      delete newtree;
      routfile->Close();
   }
   

   return 0;
   
}
